# SERVER SIDE QUICK START
## ZIWEI PENG AND PETER JANG AY18-1/2

Last updated 05JUN2018, files made in Python 2.7

### PURPOSE:

The purpose of this file is to list the contents of the serverSide directory and their purpose.

TLDR:

To run this right off the bat:

1. Use `./runServerSide.sh` (create executable if needed `chmod +x runServerSide.sh`)
2. Open index.html in Firefox
3. Use `./killServerSide.sh` to close (create executable if needed `chmod +x killServerSide.sh`)

### CONTENTS:
*Items listed in **bold** are folders

- **archive** _Contains timestamped records of flights._
- **images** _Contains image dependencies for Leaflet._
- **leaflet_src** _Contains package dependencies for Leaflet, notably Leaflet-heat. Install all other dependencies by dragging their .js files here._
- **mobac_configure** _Contains the XML configuration file for the current Google Maps hybrid map source in Mobile Atlas Creator._
- **INL_RESULTS** _Contains the raw heatmap log and the image of the heatmap from INL_
- **idaho** _Contains the map tiles for the Idaho heatmap._
- **range11** _Contains the map tiles for Range 11._
- **rivercourts** _Contains the map tiles for the River Courts._
- index.html _HTML page to view the HEATMAP_
- parsed_data.js _The working file used when running the Waypoint Server. As of the EOY Commit, it contains the data to generate the full 26APR2018 (Thursday) heatmap used in the Projects Day presentation._
- README.md _This README._
- srtm_14_04.tif _The Shuttle Radar Topography Mission Digital Elevation Module (SRTM DEM) TIFF file used to find ground elevation relative to sea level._
- style.css _Style for the HTML file, currently not in use._
- waypoint_server.py _The Waypoint Server._
- wp_data.txt _The saved set of completed survey points. Currently populated._
- wpledger.csv _Another set of survey points, deprecated_
- runServerSide.sh _Script to clear the working parsed_data.js file, run the waypoint server, and open the heatmap._
- killServerSide.sh _Script to quit the waypoint server_
- saver.py _Python script to extract arhive log data into a .js_

### THE WAYPOINT SERVER (waypoint_server.py)

This backbone of this file is a socket server. As explained in the Projects Day Presentation, its purpose is to communicate with every quad in the P2P network and receive geotagged radiation information. The server does several things:

- Receives UAV radiation, location, and altitude data
- Receives UAV survey points completed
- Uses SRTM TIFF file and UAV altitude reading to generate a relative altitude from the ground
- Converts the raw radiation readings to account for height difference and detector type (PRDER vs GN+)
- Populates parsed_data.js as it receives new data
- Sends working set of completed survey points back to quads
- Saves a timestamped archive of the data upon closing the connection

TO INSTALL DEPENDENCIES:

pip install procname
sudo apt-get install python-rasterio

TO RUN:

`python waypoint_server.py` or `./runServerSide`

### The Heatmap (index.html)

This is an HTML webpage which displays the live heatmap generated by the waypoint server. It opens in Firefox, uses the Leaflet API (which allows for the use of locally stored map tiles), and the Leaflet-heat plugin.

- The source file for the heatmap data is parsed_data.js
- The source directory for the map tiles is currently /idaho
- To set the location of the map, change the line:
`var map = L.map('map').setView([<Latitude>,<Longitude>], 18);`
to the desired geographic coordinates.
- The heatmap, like any graph, is arbitrary by itself. Adjust the opacity, radius, blur, and colors to best display the information.
- Clicking the map displays the coordinates for the mouse location
- Leaflet works by a system of layers. To get this to work properly, it is important to generate the layer in the correct order (map tiles first, then the data). If something does not show up at all, it is usually due to either a file I/O error, a syntax error, or some error with the layers interfering.

### Mobile Atlas Creator

To generate map tile for other locations, first download Mobile Atlas Creator and drag the "Google Maps.xml" file into its map sources directory.

- Open Mobile Atlas Creator and if not immediately prompted, select Create New Atlas
- Select the format as OSMDroid ZIP
- Select the map source as Google Maps Hybrid
- Navigate to the desired area. Scroll to zoom and right click to drag
- Select the desired area
- Selected the desired zoom levels. The hybrid maps source has a maximum zoom of 18
- Click "Add this selection"
- Select "Create Atlas"
- Once the .zip file is finished, unzip the file and move the nested directory to the /serverSide directory so that the folder structure corresponds to: desiredLocation/zoomLevel/XAxis/YAxis.jpg
- Rename the folder to the desired folder, then in index.html change:
`L.tileLayer('<Location Name>/{z}/{x}/{y}.jpg', {maxZoom: 18}).addTo(map);`
to the desired location name
- Change the starting location coordinate to one in the new location

### To Plot Archived Data

- `cd usma_swarm/usma_files/serverSide/archive`
- Update `saver.py` line 5 with the file name of the .csv you want to plot
- `python saver.py`
- Copy the `savedparse.js` file to `usma_swarm/usma_files/serverSide`
- Update `index.html` file to read in `savedparse.js` (line 26)
- `./runServerSide.sh`

### Other Notes

- To run this in SITL vs live, there are 2 flags to update in behavior (search for flag) and 1-2 in the ServerSide.  These switch local-host on/off (AK)
- If waypoint server crashes during run, can paste in data from `wp_data.txt` into `waypoint_server.py` finishedwp (line 30) (AK)
- The purpose of the variable finishedwp (a set) is to initialize the waypoint server in a state that already includes "finished" waypoints. The server immediately sends this data to each quad as well so that all members can begin the mission excluding the given points. This is useful in the event of a server crash (where otherwise the mission would have to start again from the very beginning), or if a certain area needs to be excluded. (ZP)
- If a mission is halted and restarted, it is important to note that the `./runServerSide` command should not be used as it would clear out the parsed_data.js file. Instead, run ./killServerSide to clear out any orphaned processes, then run `python waypoint_server.py &` and then `firefox index.html` to manually start the waypoint server. (ZP)
- In the event that the parsed_data.js file is cleared, a saved copy should still be available in the /archive directory. To extract the data from the log file, edit the `saver.py` file to open the desired log, and run `python saver.py` to produce the .js file. (ZP)
